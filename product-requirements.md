# 产品需求文档：通用轻量级 PaaS 中间件管理平台

**创建时间**: 2024-02-09

**版本**: v1.0

---

## 特征概述

本平台是一个基于 Kubernetes 的通用、可扩展、轻量级 PaaS 中间件管理系统。它允许开发者自助创建和管理多种中间件实例（如 Redis、Kafka、MySQL 等），支持通过声明式插件机制动态扩展对新中间件类型的支持，无需修改平台核心代码或重启服务。

### 核心设计原则

1. **零外部依赖**：除 Kubernetes 外，不依赖任何外部中间件（数据库、缓存、消息队列等）
2. **声明式扩展**：通过 CRD 配置即可添加新中间件类型支持
3. **原生集成**：深度复用 Kubernetes 原生能力（RBAC、ResourceQuota、NetworkPolicy 等）
4. **轻量专注**：聚焦生命周期管理、备份恢复、配置管理、监控告警四大核心功能

---

## 用户场景和测试

### 用户故事1：开发者自助创建 Redis 实例 (优先级 P1)

作为一名应用开发者，我需要快速创建一个 Redis 实例用于开发测试，而不需要等待运维团队手动部署。

**优先级原因**: 这是平台最核心的价值主张——让开发者能够自助获取所需中间件资源，缩短开发周期，减少运维负担。

**独立测试**: 可以通过在 Kubernetes 集群中创建 MiddlewareInstance CRD 完成测试并交付一个可用的 Redis 实例。

**验收场景**:
1. **给定** 开发者拥有目标 Namespace 的 create 权限，**当** 提交 MiddlewareInstance YAML 创建 Redis 实例时，**那么** 系统在 2 分钟内完成部署并提供连接信息
2. **给定** Redis 实例处于 Running 状态，**当** 执行连接测试时，**那么** 可以正常读写数据
3. **给定** 实例创建请求超出 ResourceQuota 限制，**当** 提交创建请求时，**那么** 系统立即返回配额不足错误

### 用户故事2：平台管理员添加新的中间件类型 (优先级 P1)

作为一名平台管理员，我需要添加对 Elasticsearch 的支持，而无需修改平台代码或重启服务。

**优先级原因**: 可扩展性是平台的核心竞争力，必须能够在不中断服务的情况下动态添加新的中间件类型。

**独立测试**: 可以通过创建 MiddlewareType CRD 定义 Elasticsearch 插件并完成一个 Elasticsearch 实例的部署测试。

**验收场景**:
1. **给定** 平台正在运行，**当** 创建 MiddlewareType CRD 定义 Elasticsearch 后，**那么** 开发者立即可以在创建实例时选择 Elasticsearch 类型
2. **给定** 已定义 Elasticsearch 插件，**当** 创建 Elasticsearch 实例时，**那么** 平台能正确部署并管理该实例的生命周期
3. **给定** 多个插件版本存在，**当** 查看可用类型列表时，**那么** 显示所有支持的中间件类型及其可用版本

### 用户故事3：执行定时自动备份 (优先级 P1)

作为一名开发者，我需要确保我的 MySQL 数据每天自动备份到 S3，保留最近 10 个备份。

**优先级原因**: 数据保护是生产环境的基本要求，自动备份能力直接影响平台的生产可用性。

**独立测试**: 可以通过配置备份策略并验证备份文件成功上传到 S3 完成测试。

**验收场景**:
1. **给定** MySQL 实例配置了每日备份计划，**当** 到达备份时间点时，**那么** 系统自动触发备份任务并将数据上传到指定 S3
2. **给定** 备份数量超过保留限制（如 10 个），**当** 新备份完成时，**那么** 系统自动清理最旧的备份
3. **给定** 需要从备份恢复，**当** 提交恢复请求时，**那么** 系统能基于备份创建新的实例或恢复到现有实例

### 用户故事4：跨 Namespace 管理和查看实例 (优先级 P2)

作为一名运维人员，我需要查看我负责的所有 Namespace 中的中间件实例状态。

**优先级原因**: 支持跨 Namespace 操作是满足实际运维场景的必要能力。

**独立测试**: 可以通过 RBAC 授权后跨 Namespace list/get 实例完成测试。

**验收场景**:
1. **给定** 用户被授予多个 Namespace 的权限，**当** 查询实例列表时，**那么** 返回所有授权 Namespace 中的实例
2. **给定** 用户没有被授予某 Namespace 权限，**当** 尝试访问该 Namespace 的实例时，**那么** 收到权限拒绝错误

### 边界情况

- **当** 插件定义的接口调用超时或失败时，系统应标记操作失败并在 status 中记录详细错误信息，等待人工介入
- **当** 中间件 Pod 持续无法就绪时，系统应在 status 中反映 Failed 状态并提供最后错误日志
- **当** 升级前检查失败时，系统应阻止升级操作并返回具体失败原因
- **当** 备份工具 Pod 执行失败时，系统应在 MiddlewareBackup status 中记录失败原因，不自动重试
- **当** 存储卷容量不足时，系统应支持在线扩容 PVC（如果 StorageClass 支持）

---

## 需求

### 功能需求

#### 权限与多租户

- **FR-001**: 系统必须与 Kubernetes RBAC 完全集成，用户的所有操作权限通过 K8s RBAC 控制
- **FR-002**: 系统必须支持两种隔离模式：强隔离（独立 Namespace）和弱隔离（共享 Namespace）
- **FR-003**: 系统必须支持跨 Namespace 操作，用户可在被授权的多个 Namespace 中创建和管理实例
- **FR-004**: 配额限制必须完全依赖 Kubernetes ResourceQuota，系统只读取并校验，不做额外限制
- **FR-005**: 在共享 Namespace 模式下，系统不强制区分实例归属，所有有权限的用户都能看到 Namespace 内所有实例

#### 中间件生命周期管理

- **FR-006**: 系统必须支持以下实例状态：Pending、Initializing、Running、Scaling、Upgrading、BackingUp、Restoring、Maintenance、Failed、Terminating
- **FR-007**: 系统必须支持删除实例时的可选策略：级联删除所有资源 或 保留 PVC 数据
- **FR-008**: 系统必须支持水平扩缩容（修改副本数）和垂直扩缩容（修改 CPU/Memory/磁盘）
- **FR-009**: 磁盘扩容必须支持在线扩容（不重启 Pod），CPU/Memory 变更根据 K8s 特性决定是否重启，如需重启则执行滚动重启
- **FR-010**: 系统必须支持按中间件类型配置最小和最大副本数限制
- **FR-011**: 创建实例时必须支持配置：资源规格、存储大小、实例数量、版本/镜像、网络暴露方式（ClusterIP/NodePort/LoadBalancer）、自定义配置参数
- **FR-012**: 系统必须支持从备份恢复来创建新实例
- **FR-013**: 配置参数暴露必须采用混合模式：预设模板 + 允许自定义覆盖

#### 扩展机制

- **FR-014**: 系统必须通过声明式 CRD（MiddlewareType）定义中间件类型，无需修改平台代码即可添加新类型
- **FR-015**: MiddlewareType 必须支持多版本管理，每个版本一旦发布不可修改，实例必须显式指定使用的插件版本
- **FR-016**: 插件版本升级必须支持原地滚动更新，且高版本插件必须通过 upgradeFrom 字段声明可从哪些低版本升级
- **FR-017**: 同插件版本内必须支持切换不同的中间件软件版本（如 redis-plugin-v1 支持 Redis 7.2.7 和 7.2.11）
- **FR-018**: 升级前必须调用插件接口进行兼容性检查，检查失败时不允许升级
- **FR-019**: 复杂生命周期操作（failover、scale-in 等）必须通过抽象接口调用 Pod 暴露的 gRPC/HTTP 接口执行
- **FR-020**: 插件必须提供 CUE 格式的配置模板，用于验证用户输入的配置参数
- **FR-021**: 插件接口必须在固定端口（默认 8080）的标准路径上暴露，包括：/health、/init、/pre-upgrade 等
- **FR-022**: Operator 与 Pod 接口通信不需要认证，假定集群内网络可信

#### 备份恢复

- **FR-023**: 系统必须通过启动独立的工具 Pod（Job）执行备份操作，避免在业务 Pod 中执行备份命令
- **FR-024**: 备份工具镜像必须由 MiddlewareType 定义，不同中间件类型可使用不同的备份工具和版本
- **FR-025**: 备份数据必须上传到 S3 兼容对象存储，系统必须支持配置多个 S3 服务端点，备份时指定使用哪个端点
- **FR-026**: 备份元数据必须通过 MiddlewareBackup CRD 记录，同时必须在 S3 端存储元数据文件，支持通过 S3 元数据恢复 CRD 实例
- **FR-027**: 系统必须支持手动触发备份和定时自动备份（Cron 表达式）
- **FR-028**: 备份保留策略必须支持设置最大数量和最大保留时长
- **FR-029**: 过期备份的清理必须通过独立的清理 Job 执行

#### 配置管理

- **FR-030**: 中间件配置必须存储在标准 Kubernetes ConfigMap 或 Secret 中，MiddlewareInstance 通过引用使用
- **FR-031**: 配置变更的处理逻辑必须由中间件 Pod 内的进程自行实现，Operator 只负责更新 ConfigMap/Secret
- **FR-032**: 系统必须在应用配置前使用 CUE 模板对用户输入进行渲染和验证

#### 监控告警

- **FR-033**: 监控必须完全外置，平台确保中间件实例能被外部监控系统发现，平台本身不处理监控数据采集
- **FR-034**: 告警必须完全外置，由外部系统（如 Prometheus Alertmanager）处理
- **FR-035**: 如需告警通知，平台只提供 Webhook 回调支持

#### 安全性

- **FR-036**: 是否启用认证必须由中间件实例的具体配置决定，但平台必须提供基本的 TLS 支持（通过 cert-manager 集成）
- **FR-037**: 敏感信息管理必须支持两种方式：平台自动生成随机密码存储在 Secret 中，或用户指定已有的 Secret
- **FR-038**: NetworkPolicy 管理完全由集群管理员自行配置，平台不自动干预网络策略
- **FR-039**: Pod 安全上下文必须由 MiddlewareType 定义，不同中间件类型可有不同的安全要求

### 关键数据实体

- **ENTITY-1: MiddlewareType**：定义中间件类型的元数据和生命周期行为
  - 属性：name, pluginVersion, supportedVersions, images, lifecycleHooks, scalingRules, backupConfig, securityContext, configTemplate (CUE)
  - 关系：一对多关联 MiddlewareInstance

- **ENTITY-2: MiddlewareInstance**：表示一个具体的中间件实例
  - 属性：type, pluginVersion, middlewareVersion, namespace, resources, storage, replicas, configRef, serviceType, status
  - 关系：多对一关联 MiddlewareType，一对多关联 MiddlewareBackup

- **ENTITY-3: MiddlewareBackup**：表示一次备份任务和备份元数据
  - 属性：instanceRef, s3Endpoint, s3Path, status, startTime, completionTime, size, retention
  - 关系：多对一关联 MiddlewareInstance

- **ENTITY-4: S3StorageConfig**：（存储在 ConfigMap 或独立 CRD）定义 S3 服务端点和凭据引用
  - 属性：name, endpoint, bucket, region, credentialSecretRef

---

## 成功标准

### 可衡量的结果

- **SC-001**: 开发者可以在 2 分钟内完成中间件实例创建并获得可用连接
- **SC-002**: 平台可以在不重启服务的情况下，在 30 秒内识别并使用新添加的中间件类型
- **SC-003**: 备份任务成功率达到 99.5% 以上，备份数据完整性可通过校验和验证
- **SC-004**: 平台自身运行时除 Kubernetes API Server 外，不依赖任何外部服务（数据库、缓存、消息队列等）
- **SC-005**: 水平扩缩容操作在 60 秒内完成，垂直扩缩容（需重启场景）在 5 分钟内完成滚动更新
- **SC-006**: 插件定义的 CUE 配置验证能在 1 秒内完成并返回明确的错误信息
- **SC-007**: 平台支持同时管理至少 1000 个中间件实例，单个 Operator 实例内存占用不超过 512MB
- **SC-008**: 90% 的开发者能够在首次尝试时成功创建中间件实例，无需查阅详细文档

### 技术约束

- **TC-001**: 平台必须以原生 Kubernetes Operator 形式运行，遵循 Operator SDK 最佳实践
- **TC-002**: 所有状态必须存储在 Kubernetes ETCD 中，禁止引入外部状态存储
- **TC-003**: 平台代码必须使用声明式而非命令式方式管理资源
- **TC-004**: 插件机制必须向后兼容，新版本 Operator 必须能识别旧版本的 MiddlewareType

---

## 假设与依赖

### 假设

1. **Kubernetes 版本**: 目标集群运行 Kubernetes 1.24+，支持所需的 API 版本（如 CronJob v1）
2. **存储类**: 集群提供支持在线扩容的 StorageClass（如 CSI 驱动）
3. **网络**: 集群内部网络可信，Pod 间通信不需要加密认证
4. **cert-manager**: 如需自动 TLS 证书管理，集群已安装 cert-manager
5. **S3 服务**: 用户提供可用的 S3 兼容对象存储服务用于备份

### 外部依赖

| 组件 | 用途 | 必需/可选 |
|------|------|-----------|
| Kubernetes API Server | 资源管理和状态存储 | 必需 |
| Container Runtime | 运行 Pod | 必需 |
| S3 兼容存储 | 备份数据存储 | 可选（如不启用备份功能） |
| cert-manager | 自动 TLS 证书管理 | 可选 |
| External-DNS | 自动 DNS 记录管理 | 可选 |

---

## 非功能性需求

### 性能

- 单个 Operator 实例应能管理至少 1000 个中间件实例
- API 响应时间（CRD 创建/更新）P99 < 500ms
- 状态同步延迟（期望状态与实际状态一致）< 30 秒

### 可靠性

- Operator 自身必须具备高可用性，支持多副本部署（Leader Election）
- 单点故障不应影响已运行的中间件实例
- 支持优雅关闭，确保正在执行的操作（如备份）能完成或正确回滚

### 可维护性

- 提供清晰的日志级别（Debug/Info/Warning/Error）
- 关键操作必须有审计日志记录
- 支持通过 metrics 暴露平台运行状态

---

## 风险与缓解措施

| 风险 | 影响 | 可能性 | 缓解措施 |
|------|------|--------|----------|
| 插件配置错误导致实例无法创建 | 高 | 中 | 提供 CUE 模板预验证，增加 dry-run 模式 |
| 备份任务长时间占用资源 | 中 | 中 | 设置备份任务资源限制和超时时间 |
| 跨版本升级数据不兼容 | 高 | 低 | 强制 pre-upgrade 检查，提供升级回滚机制 |
| 大量实例导致 Operator 性能下降 | 中 | 中 | 支持 Operator 水平扩展（分片或按 Namespace） |
| 敏感信息泄露 | 高 | 低 | Secret 使用加密存储，最小权限 RBAC 设计 |
