# 特性规范：通用PaaS中间件管理平台

**创建时间**：2026-02-11

**特性概述**：
基于Kubernetes的通用、可扩展、轻量级PaaS中间件管理平台，支持管理多种中间件（Redis、PostgreSQL等），具备以下核心特性：
- 通过扩展机制支持任意中间件类型，添加新中间件无需修改平台代码或重启
- 提供专用工作负载，支持高级特性（指定缩容Pod编号、指定滚动重启顺序）
- 通过静态/动态分组抽象支持任意部署拓扑
- 通过统一REST API实现中间件生命周期管理
- 支持备份、配置管理、监控告警等核心功能
- 轻量级设计，不引入外部中间件依赖

## 用户场景和测试

### 用户故事1：快速创建中间件实例 (优先级 P1)
作为平台运维人员，我需要快速创建Redis或PostgreSQL中间件实例，无需深入了解Kubernetes细节。

**优先级原因**：这是平台最基础的功能，为用户提供即用型的中间件服务，大幅提升运维效率。

**独立测试**：可以通过创建Redis集群和PostgreSQL主从集群完成测试，验证平台能够成功部署并初始化中间件。

**验收场景**：
1. **给定** 平台已安装Redis扩展v1.0，**当** 用户提交创建3节点Redis集群的请求，**那么** 平台在5分钟内创建完成，集群状态变为Running，用户可以获取连接信息
2. **给定** 平台已安装PostgreSQL扩展v1.0，**当** 用户提交创建1主2从集群的请求，**那么** 平台自动完成主从复制配置，从节点同步主节点数据

### 用户故事2：动态扩缩容 (优先级 P1)
作为平台运维人员，我需要在不中断服务的情况下，对中间件集群进行扩缩容操作。

**优先级原因**：业务增长需要扩容，成本优化需要缩容，这是生产环境的核心需求。

**独立测试**：可以通过对现有Redis集群执行扩容和缩容操作完成测试，验证数据一致性和服务可用性。

**验收场景**：
1. **给定** 一个3节点的Redis集群正在运行，**当** 用户发起扩容到5节点的操作，**那么** 新节点自动加入集群，数据自动重平衡，整个过程服务可用
2. **给定** 一个5节点的Redis集群正在运行，**当** 用户指定删除节点编号2进行缩容，**那么** 节点2的数据迁移到其他节点后安全下线，集群缩容至4节点

### 用户故事3：版本升级管理 (优先级 P1)
作为基础设施团队，我需要支持扩展版本升级（如Redis扩展v1.0到v2.0）和中间件版本升级（如Redis 6.0到7.0），且在升级前后通过各自独立的生命周期API执行准备、验证和收尾工作，不影响现有集群运行。

**优先级原因**：扩展版本升级支持平台功能演进，中间件版本升级支持软件特性更新，两者使用不同的生命周期API接口，确保升级过程安全可控且互不干扰。

**独立测试**：可以通过扩展版本升级或中间件版本升级完成测试，验证各自的生命周期API在升级前后被正确调用。

**验收场景**：
1. **给定** 平台已安装Redis扩展v1.0（支持Redis 6.0），且有运行中的Redis 6.0集群，**当** 安装Redis扩展v2.0并执行扩展版本升级操作，**那么** 系统调用pre-extension-upgrade API执行准备工作，集群滚动重启完成升级，期间调用post-extension-upgrade API验证升级结果，服务保持可用，扩展版本升级到v2.0
2. **给定** 平台已安装Redis扩展v2.0（支持Redis 6.0和7.0），且有运行中的Redis 6.0集群，**当** 用户提交中间件版本升级到Redis 7.0的请求，**那么** 系统调用pre-middleware-upgrade API执行兼容性检查和数据备份，按滚动顺序升级各节点，调用post-middleware-upgrade API验证集群功能正常，期间服务可用
3. **给定** 扩展版本升级过程中出现问题，**当** 用户执行回滚操作，**那么** 系统调用pre-extension-rollback API准备回滚环境，执行回滚操作，调用post-extension-rollback API验证回滚结果，集群恢复到升级前状态
4. **给定** 中间件版本升级过程中出现问题，**当** 用户执行回滚操作，**那么** 系统调用pre-middleware-rollback API准备回滚环境，执行回滚操作，调用post-middleware-rollback API验证回滚结果，集群恢复到升级前版本

### 用户故事4：添加新中间件支持 (优先级 P2)
作为基础设施团队，我需要添加Kafka支持，而无需修改平台核心代码或重启Operator。

**优先级原因**：平台的可扩展性是其核心价值，支持未来可能出现的任何中间件。

**独立测试**：可以通过开发并安装Kafka扩展，然后成功创建Kafka集群完成测试。

**验收场景**：
1. **给定** 平台运行正常，**当** 安装Kafka扩展v1.0，**那么** 平台自动识别扩展，用户可立即创建Kafka集群，无需重启Operator
2. **给定** Kafka扩展已安装，**当** 用户创建KRaft模式的Kafka集群，**那么** 平台正确部署controller和broker节点，集群正常运行

### 用户故事5：进程生命周期管理 (优先级 P1)
作为平台运维人员，我需要在不重启Pod的情况下，对中间件进程执行完整的生命周期管理（启动、停止、重启），并支持批量操作和自动拉起策略。

**优先级原因**：精细的进程控制能力是平台的核心差异化特性，允许运维人员在保持Pod/容器稳定运行的前提下，灵活控制中间件进程，避免不必要的服务中断，支持维护窗口、故障恢复等场景。

**独立测试**：可以通过对指定Pod的Redis进程执行停止、启动、重启操作完成测试，验证进程正确响应且Pod不重启，同时验证批量操作和自动拉起功能。

**验收场景**：
1. **给定** Redis集群正常运行，**当** 用户对指定Pod执行进程停止操作（优雅停止，超时30秒），**那么** 中间件进程接收SIGTERM信号，在超时时间内优雅退出，Pod保持Running状态但Readiness变为Not Ready，从Service端点移除
2. **给定** 某Pod的中间件进程已停止，**当** 用户执行进程启动操作，**那么** 进程管理器启动新的中间件进程，新进程获得新PID，Readiness恢复为Ready
3. **给定** Redis集群正常运行，**当** 用户执行进程重启操作，**那么** 进程管理器先停止再启动中间件进程，整个过程Pod不重启，新进程获得新PID
4. **给定** 需要对集群进行维护，**当** 用户对所有从节点批量执行进程停止操作（并发数2，滚动间隔10秒），**那么** 按策略依次停止各从节点进程，主节点保持运行
5. **给定** 进程管理器配置为自动拉起模式，**当** 中间件进程异常退出（非用户主动停止），**那么** 进程管理器自动重新启动中间件进程
6. **给定** 进程管理器运行中，**当** 用户更新进程管理器配置（如修改自动拉起策略），**那么** 配置热更新生效，无需重启Pod

### 边界情况
- 当扩展升级失败时，系统应支持自动或手动回滚到升级前状态
- 当缩容指定的Pod编号不存在时，系统应返回明确错误，不进行任何操作
- 当生命周期API调用超时或失败时，系统应根据扩展定义的策略决定重试或终止操作
- 当配置验证失败（Cue模板检查不通过）时，系统拒绝应用配置并返回详细错误信息
- 当备份存储不可用时，备份操作应失败并告警，不影响中间件正常运行
- 当Pod被删除或停止时（Kubelet发送SIGTERM给主容器），进程管理器作为PID 1必须正确转发信号给中间件进程，确保中间件进程优雅退出
- 当中间件版本升级的目标版本不在扩展支持的版本列表中时，系统拒绝升级并返回错误
- 当pre-middleware-upgrade生命周期API返回不兼容或备份未完成的响应时，系统暂停中间件版本升级流程，等待用户处理
- 当中间件版本升级跨多个版本（如6.0→7.0）且用户未按声明的单步路径依次升级时，系统拒绝升级并提示用户先升级到中间版本（如6.0→6.2）
- 当扩展版本升级时，如果当前扩展版本不在目标扩展版本声明的"可升级上来的低版本号列表"中时，系统拒绝升级并返回错误

## 需求

### 功能需求

- **FR-001**: 系统必须支持通过统一CRD创建中间件实例，用户只需指定中间件类型、扩展版本、中间件版本和拓扑配置
- **FR-002**: 系统必须支持扩展机制，扩展以ConfigMap和Secret形式交付，包含Pod模板、生命周期API定义、Cue配置模板和元数据
- **FR-003**: 系统必须支持扩展的多版本共存，同一中间件类型可同时安装多个扩展版本
- **FR-004**: 系统必须支持扩展版本升级和中间件版本升级的独立执行，两者可以分别进行，互不影响
- **FR-005**: 系统必须支持扩展版本升级，高版本扩展在元数据中声明可升级到自己的低版本号列表（如v2.0声明支持从v1.0、v1.1升级），系统只执行单步升级，升级过程中调用pre-extension-upgrade和post-extension-upgrade生命周期API执行准备和验证，升级失败支持通过pre-extension-rollback和post-extension-rollback回滚
- **FR-006**: 系统必须支持中间件版本升级，扩展在元数据中声明支持的升级路径（如6.0→6.2、6.2→7.0），系统只执行单步升级，升级前通过pre-middleware-upgrade生命周期API执行兼容性检查和数据备份确认，升级后通过post-middleware-upgrade生命周期API验证集群功能正常，验证失败支持通过pre-middleware-rollback和post-middleware-rollback回滚，跨版本升级需用户依次执行
- **FR-007**: 系统必须提供专用工作负载 ExPodSet，支持指定缩容时删除的Pod编号
- **FR-008**: ExPodSet 必须支持指定滚动重启顺序，通过调用Pod REST API获取重启序列
- **FR-009**: 系统必须支持静态分组和动态分组的拓扑抽象，静态分组定义Pod模板，动态分组管理具体副本
- **FR-010**: 系统必须支持运行时管理静态分组和动态分组，包括添加、删除、修改
- **FR-011**: 系统必须定义通用生命周期REST API接口规范，包括扩缩容相关（pre-scale-in、post-scale-out）、健康检查（health-check）等基础生命周期接口，以及版本升级相关的8个接口（pre-extension-upgrade、post-extension-upgrade、pre-extension-rollback、post-extension-rollback、pre-middleware-upgrade、post-middleware-upgrade、pre-middleware-rollback、post-middleware-rollback）
- **FR-012**: 平台必须提供通用的、可配置的生命周期API Server镜像（Generic Lifecycle API Server），该Server实现系统定义的所有通用生命周期REST API接口；扩展开发者基于该镜像制作扩展专用镜像，只需拷贝中间件专用脚本并配置API到脚本的映射关系，无需自行实现HTTP Server
- **FR-013**: 通用生命周期API Server必须通过配置映射表声明实现的生命周期API与执行命令的对应关系，格式为"API路径→执行命令/脚本"；扩展制作镜像时提供此配置文件
- **FR-014**: 通用生命周期API Server必须提供能力发现端点（如/capabilities），根据配置返回该扩展实现的所有生命周期API列表，系统通过调用此端点获知扩展的能力
- **FR-015**: 通用生命周期API Server收到系统调用请求后，必须根据配置执行对应的脚本或命令，并将执行结果（成功/失败、输出信息）返回给系统
- **FR-016**: 系统必须通过Headless Service同步调用扩展提供的生命周期API，调用超时时间和重试策略可配置
- **FR-017**: 通用生命周期API Server必须支持标准HTTP状态码（200表示成功，4xx/5xx表示失败）和JSON格式的响应体，包含执行状态、消息和可选的详细数据
- **FR-018**: 扩展制作生命周期API Server镜像时，必须基于平台提供的通用生命周期API Server镜像，将中间件专用脚本/命令和LifecycleAPIConfig配置文件打包到镜像中，无需编写HTTP Server代码
- **FR-019**: 系统必须在每个中间件Pod的主容器内运行进程管理器（PID 1），负责中间件进程的完整生命周期管理，进程管理器支持systemd类似功能
- **FR-020**: 系统必须支持通过REST API对单个Pod执行进程启动操作，进程管理器在主容器内启动新的中间件进程，Pod不重启
- **FR-021**: 系统必须支持通过REST API对单个Pod执行进程停止操作，支持优雅停止（SIGTERM）和强制停止（SIGKILL）两种模式，用户可配置优雅停止超时时间
- **FR-022**: 系统必须支持通过REST API对单个Pod执行进程重启操作，由进程管理器执行停止后启动，新进程获得新PID，Pod和容器不重启
- **FR-023**: 系统必须支持进程级健康检查，当中间件进程停止时，Pod的Readiness Probe应自动变为Not Ready，从Service端点移除
- **FR-024**: 系统必须支持批量进程操作，用户可对整个集群或指定分组（如所有从节点）执行启动/停止/重启操作，支持配置并发数和滚动间隔策略
- **FR-025**: 进程管理器必须支持自动拉起模式（可配置），当中间件进程异常退出（非用户主动停止）时，进程管理器自动重新启动进程
- **FR-026**: 进程管理器必须支持配置热更新，用户可修改进程管理器配置（如自动拉起策略、健康检查参数）而无需重启Pod
- **FR-027**: 进程管理器作为PID 1运行时，当收到SIGTERM停止信号，必须将信号转发给中间件进程，等待其优雅退出后，进程管理器自身才退出
- **FR-028**: 系统必须支持自动备份，备份策略由用户配置，扩展定义备份步骤，备份存储于对象存储
- **FR-029**: 系统必须支持跨集群恢复，只要多集群能访问相同备份仓库
- **FR-030**: 系统必须支持配置热更新，通过Cue模板验证配置，扩展提供配置模板，用户提供完整配置文件
- **FR-031**: 系统必须支持配置回滚到上一版本
- **FR-032**: 系统必须通过Prometheus格式暴露监控指标，扩展在Pod模板中提供exporter sidecar定义
- **FR-033**: 系统必须支持多种日志收集方式，包括stdout输出、文件日志、日志轮转，由扩展通过sidecar实现
- **FR-034**: 系统必须集成cert-manager为中间件提供TLS证书和自动轮转能力
- **FR-035**: 系统必须支持私有镜像仓库，并支持配置镜像拉取密钥
- **FR-036**: 系统必须使用Kubernetes原生RBAC控制权限，用户的操作权限完全由其K8s权限决定
- **FR-037**: 中间件Pod必须自动探测并更新自身角色Label

### 关键数据实体

- **ENTITY-1**: Extension（扩展），代表一种中间件类型的支持包，包含扩展版本、支持的中间件版本列表、可升级上来的低版本扩展号列表（如v2.0支持从v1.0、v1.1升级）、中间件版本升级路径声明（如6.0→6.2）、元数据
- **ENTITY-2**: MiddlewareCluster（中间件集群），代表一个中间件实例，包含扩展版本、中间件版本、拓扑配置（静态分组和动态分组）、状态信息
- **ENTITY-3**: StaticGroup（静态分组），定义一组动态分组共享的Pod模板，包含资源配置、镜像信息、配置模板
- **ENTITY-4**: DynamicGroup（动态分组），代表一个ExPodSet实例，包含副本数、特定配置覆盖、状态信息
- **ENTITY-5**: BackupPolicy（备份策略），定义自动备份的调度规则、保留策略，由用户配置
- **ENTITY-6**: BackupRecord（备份记录），代表一次备份的结果，包含备份类型、时间、存储位置、状态
- **ENTITY-7**: ProcessManagerConfig（进程管理器配置），定义进程管理器的行为参数，包括自动拉起策略、优雅停止超时时间、健康检查配置、信号映射规则
- **ENTITY-8**: LifecycleAPIConfig（生命周期API配置），由扩展提供，定义扩展实现的生命周期API与执行命令的映射关系，包含API路径、执行命令/脚本、超时时间、重试策略；通用生命周期API Server读取此配置处理请求

## 成功标准

### 可衡量的结果

- **SC-001**: 用户可以在10分钟内完成新中间件集群的创建（从提交请求到集群可用）
- **SC-002**: 扩容操作在5分钟内完成，期间服务可用性不低于99.9%
- **SC-003**: 扩展升级过程支持零停机，滚动重启单个Pod的时间不超过30秒
- **SC-004**: 添加新中间件支持无需修改平台代码，新扩展安装后立即可用（无需重启Operator）
- **SC-005**: 平台可以管理数百个中间件集群，每个集群规模从单节点到数十个节点
- **SC-006**: 配置更新操作在1分钟内完成验证和应用（验证时间<10秒，滚动重启时间<60秒）
- **SC-007**: 备份成功率不低于99%，备份数据完整性可验证
- **SC-008**: 用户可以通过统一API管理所有类型的中间件，学习成本降低50%以上
- **SC-009**: 进程停止/启动/重启操作在单个Pod上10秒内完成，整个过程Pod保持Running状态，不触发容器重启
- **SC-010**: 批量进程操作支持并发控制，用户可指定并发数（如同时操作不超过2个Pod），滚动间隔可配置（如10秒）
- **SC-011**: 进程管理器配置热更新在5秒内生效，无需重启Pod
- **SC-012**: 当进程管理器配置为自动拉起模式时，中间件进程异常退出后，新进程在3秒内自动启动

## 假设

- 用户具备Kubernetes基础知识和操作权限
- 集群已安装cert-manager用于TLS证书管理
- 有可用的对象存储用于备份数据
- 扩展开发者熟悉Kubernetes CRD和Operator模式
- 所有中间件镜像都遵循容器化最佳实践，支持信号处理
- 中间件Pod的主容器使用进程管理器作为PID 1，进程管理器支持systemd类似功能（自动拉起、信号转发、配置热更新）；当进程管理器收到停止信号时，会将信号转发给中间件进程并等待其优雅退出

## 约束

- 平台不引入外部中间件依赖（如结构化数据库、缓存等），仅依赖Kubernetes原生资源
- 暂不支持中间件暴露外部访问（Ingress/LoadBalancer）
- 暂不支持中间件密码自动生成和管理
- 告警规则由外部Prometheus Alertmanager自行配置，平台不处理告警通知
- 用户权限完全由Kubernetes RBAC控制，平台不实现额外的权限系统
