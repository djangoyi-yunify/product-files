# 特性规范：通用中间件PaaS管理平台（Paamesh）

**创建时间**：2026-02-10

**特性概述**：
基于Kubernetes的通用、可扩展、轻量级专用PaaS管理平台。通过Operator模式实现，支持管理多种中间件（Redis、PostgreSQL等），具备强大的扩展能力，可在不修改Operator代码、不重启Operator Pod的情况下添加对新中间件的支持。平台提供专门设计的PaaStatefulSet工作负载，支持精细的容器内进程管理、灵活的部署拓扑抽象，以及完整的生命周期、备份、配置、监控告警管理功能。

## 用户场景和测试

### 用户故事1：通过扩展包快速添加Redis支持 (优先级 P1)

平台团队需要为内部用户提供Redis集群管理能力。通过创建MiddlewareAddon CR和ConfigMap，将Redis扩展包注册到平台，无需修改Operator代码或重启Operator，即可开始创建和管理Redis集群。

**优先级原因**: 扩展机制是平台的核心能力，验证平台能否在不中断服务的情况下支持新中间件，是平台价值的核心体现。

**独立测试**: 可以通过创建MiddlewareAddon CR和扩展包ConfigMap，验证平台能够识别并加载Redis扩展包，随后创建RedisCluster CR并成功部署Redis集群。

**验收场景**: 
1. **给定** 平台已运行且Redis扩展包已准备好，**当** 用户创建MiddlewareAddon CR引用扩展包ConfigMap后，**那么** Operator能够自动发现并加载扩展包，状态显示为Active
2. **给定** Redis扩展包已加载，**当** 用户创建RedisCluster CR后，**那么** 平台能够根据扩展包定义成功创建并管理Redis集群

### 用户故事2：精细控制Redis主从节点缩容 (优先级 P1)

运维团队需要缩容Redis主从集群，移除特定的从节点。通过平台指定要删除的Pod编号，平台先调用Pod的pre-terminate API等待数据迁移完成，然后再删除Pod，避免影响集群可用性。

**优先级原因**: 精确缩容是PaaStatefulSet的核心差异化能力，解决StatefulSet只能删除最大编号Pod的局限性，是中间件运维的关键需求。

**独立测试**: 可以通过创建包含3个节点的Redis主从集群，然后指定删除编号为1的Pod，验证平台能否准确删除指定Pod并正确处理pre-terminate钩子。

**验收场景**: 
1. **给定** Redis集群有3个节点（编号0,1,2），**当** 用户指定删除节点1后，**那么** 平台调用节点1的pre-terminate API，等待成功后删除该Pod，节点0和2继续运行
2. **给定** 指定Pod的pre-terminate API返回失败，**当** 用户尝试删除该Pod后，**那么** 平台保留该Pod并报告错误，不执行删除操作

### 用户故事3：有序重启Redis集群减少主从切换 (优先级 P1)

运维团队需要重启Redis集群进行配置更新。平台通过扩展包获取重启顺序（先重启从节点，再重启主节点），逐个重启Pod并等待健康检查通过，减少主从切换次数和系统不可用时间。

**优先级原因**: 有序重启是保障中间件高可用性的关键能力，避免所有节点同时重启导致的服务中断，对于生产环境至关重要。

**独立测试**: 可以通过创建Redis主从集群，触发滚动重启操作，验证平台是否按照扩展包定义的顺序（从节点优先）执行重启。

**验收场景**: 
1. **给定** Redis集群有1个主节点和2个从节点，**当** 用户触发滚动重启后，**那么** 平台先重启从节点，等待健康检查通过后，再重启主节点
2. **给定** 某个Pod重启后健康检查超时，**当** 重启流程中断后，**那么** 平台报告错误，停止继续重启其他Pod，已完成的重启保持现状

### 用户故事4：不重启Pod更新Redis配置 (优先级 P2)

运维团队需要调整Redis的maxmemory配置。用户更新CR中的配置后，平台通过CUE校验配置有效性，更新ConfigMap后调用所有Pod的REST API通知配置变化，由Redis自身决定是否热加载或重启进程。

**优先级原因**: 配置热更新能力显著提升运维效率，避免不必要的Pod重启，减少服务中断风险。

**独立测试**: 可以通过更新RedisCluster CR的配置字段，验证配置能够正确更新到ConfigMap，并触发Pod的回调通知。

**验收场景**: 
1. **给定** Redis集群正在运行，**当** 用户更新CR中的配置且通过CUE校验后，**那么** 平台更新ConfigMap并调用所有Pod的API通知配置变化
2. **给定** 用户提交了无效的CUE配置，**当** 尝试应用配置后，**那么** 平台拒绝更新并返回CUE校验错误信息

### 用户故事5：执行Redis集群备份 (优先级 P2)

运维团队需要定期备份Redis数据。扩展包定义备份步骤（如执行BGSAVE，上传RDB文件到对象存储），平台按照扩展包定义执行备份流程，管理备份任务的生命周期。

**优先级原因**: 数据备份是生产环境数据保护的基础能力，平台需要提供标准化的备份协调机制。

**独立测试**: 可以通过创建备份任务CR，验证平台能够按照扩展包定义的步骤执行备份，并正确管理备份状态。

**验收场景**: 
1. **给定** Redis集群正在运行且扩展包已定义备份步骤，**当** 用户创建备份任务后，**那么** 平台按照扩展包定义的步骤执行备份，并记录备份状态
2. **给定** 备份过程中某个步骤失败，**当** 平台检测到失败后，**那么** 停止后续步骤，标记备份任务为失败状态并记录错误信息

### 边界情况

- **边界1**：当扩展包加载失败时，平台应该标记Addon状态为Failed，不影响已运行的中间件集群，用户可以查看错误日志定位问题
- **边界2**：当PaaStatefulSet缩容指定的Pod不存在时，平台应该返回清晰的错误信息，不执行任何操作
- **边界3**：当中间件Pod的REST API无响应时，平台应该在超时后标记操作失败，不无限期等待
- **边界4**：当扩展包定义的pre-terminate/pre-delete钩子执行超时，平台应该根据策略（继续或中止）处理，默认策略可配置
- **边界5**：当Operator自身发生故障时，已运行的中间件集群应该不受影响，Operator恢复后能够自动重新接管管理

## 需求

### 功能需求

#### 扩展机制
- **FR-001**: 系统必须支持通过MiddlewareAddon CR动态注册中间件扩展包，无需修改Operator代码或重启Operator Pod
- **FR-002**: MiddlewareAddon CR必须能够引用包含扩展包内容的ConfigMap/Secret，包括CUE校验文件、部署模板、生命周期钩子定义
- **FR-003**: 系统必须能够自动检测扩展包的变化（通过watch MiddlewareAddon CR），动态加载或更新扩展包
- **FR-004**: 扩展包必须包含CUE schema文件，用于校验用户提交的配置数据
- **FR-005**: 扩展包必须能够定义中间件的部署拓扑结构，包括静态分组和动态分组的组织方式

#### PaaStatefulSet工作负载
- **FR-006**: 系统必须提供PaaStatefulSet CRD，支持类似StatefulSet的稳定网络标识、稳定存储、有序部署能力
- **FR-007**: PaaStatefulSet必须支持精确缩容，允许用户指定要删除的Pod编号，而不是只能删除最大编号的Pod
- **FR-008**: PaaStatefulSet必须支持有序重启，能够通过扩展包定义的接口获取Pod重启顺序
- **FR-009**: PaaStatefulSet必须支持原地更新特性（通过feature gate控制），在支持的Kubernetes版本下能够不重建Pod更新镜像/资源
- **FR-010**: PaaStatefulSet必须支持多静态分组，每个静态分组可以有独立的Pod模板和副本数配置

#### 分组与拓扑抽象
- **FR-011**: 系统必须支持静态分组概念，静态分组在部署时确定，基于二进制运行时划分（如ES节点、Kibana节点）
- **FR-012**: 系统必须支持动态分组概念，动态分组在运行时确定，通过Pod labels标识，可动态调整
- **FR-013**: 每个动态分组必须对应一个PaaStatefulSet实例，作为其工作负载
- **FR-014**: 系统必须支持跨静态分组的操作顺序定义，在扩展包中预定义静态分组的生命周期操作顺序
- **FR-015**: 系统必须支持在静态分组内部对动态分组执行生命周期操作，操作顺序由Pod暴露的REST API提供

#### 容器内进程管理
- **FR-016**: 平台必须提供基础容器镜像，包含进程管理工具和REST API Server，扩展包在此基础上构建中间件镜像
- **FR-017**: 中间件容器必须暴露REST API，支持进程启动、停止、重启、状态查询等操作
- **FR-018**: 平台必须能够通过HTTP调用Pod的REST API触发进程管理操作，不依赖kubectl exec
- **FR-019**: 平台必须支持配置更新后通过HTTP回调通知Pod，由中间件自身决定是否热加载配置或重启进程
- **FR-020**: 平台必须支持进程管理操作的超时控制，防止无限期等待

#### 生命周期管理
- **FR-021**: 系统必须支持中间件集群的创建、删除、启动、停止、版本升级等生命周期操作
- **FR-022**: 系统必须支持对指定动态分组执行生命周期操作（启动、停止、扩缩容）
- **FR-023**: 系统必须支持跨所有静态分组的生命周期操作（如版本升级）
- **FR-024**: 扩展包必须能够定义生命周期钩子（pre-create、post-create、pre-scale、post-scale、pre-upgrade、post-upgrade、pre-delete、post-delete）
- **FR-025**: 在执行删除操作前，系统必须调用扩展包定义的pre-delete钩子或Pod的pre-terminate API，等待成功后再执行删除

#### 配置管理
- **FR-026**: 系统必须支持通过CRD接受用户提交的原始配置文件内容
- **FR-027**: 系统必须使用CUE schema对配置进行校验，校验通过后才允许应用配置
- **FR-028**: 系统必须将非敏感配置存储在ConfigMap中，敏感配置存储在Secret中
- **FR-029**: 系统在配置更新后必须调用所有相关Pod的REST API通知配置变化
- **FR-030**: 系统必须支持配置的版本管理和回滚能力

#### 备份恢复
- **FR-031**: 扩展包必须能够定义备份执行步骤和使用的工具镜像或需要调用的REST API
- **FR-032**: 系统必须按照扩展包定义的步骤执行备份任务，管理备份任务的生命周期
- **FR-033**: 系统必须支持备份任务的调度配置（通过cron表达式）
- **FR-034**: 系统必须记录备份任务的状态和结果，支持查询历史备份记录

#### 监控告警
- **FR-035**: 系统必须支持通过exporter sidecar模式暴露中间件的Prometheus metrics
- **FR-036**: 系统必须能够为中间件集群自动生成ServiceMonitor配置供Prometheus采集
- **FR-037**: 扩展包必须能够定义中间件特定的告警规则
- **FR-038**: 系统必须提供metrics和告警规则的统一管理视图

#### 安全性与网络
- **FR-039**: 系统必须支持通过cert-manager为中间件集群自动签发TLS证书
- **FR-040**: 系统必须支持配置中间件集群的TLS加密通信，可由用户选择开启或关闭

### 关键数据实体

- **ENTITY-1 MiddlewareAddon**: 中间件扩展包注册信息，包含中间件类型、版本、描述、内容引用（CUE schema、部署模板、钩子定义等）、状态
- **ENTITY-2 PaaStatefulSet**: 增强版StatefulSet，支持精确缩容、有序重启、原地更新、多静态分组，关联Pod模板、存储模板、副本数配置
- **ENTITY-3 StaticGroup**: 静态分组定义，包含名称、Pod模板、副本数、关联的动态分组列表、操作顺序配置
- **ENTITY-4 DynamicGroup**: 动态分组定义，包含名称、所属静态分组、PaaStatefulSet引用、成员Pod列表
- **ENTITY-5 MiddlewareCluster** (抽象): 中间件集群CR（如RedisCluster、PostgreSQLCluster），包含静态分组配置、全局配置、备份配置、状态
- **ENTITY-6 BackupTask**: 备份任务定义，包含目标集群、备份策略、执行步骤、状态、结果
- **ENTITY-7 Configuration**: 配置数据，包含原始配置内容、CUE校验结果、版本历史、应用状态

## 成功标准

### 可衡量的结果
- **SC-001**: 用户可以在不重启Operator的情况下，在5分钟内完成新中间件扩展包的注册和激活
- **SC-002**: 平台能够同时管理100-1000个中间件集群，Operator故障不影响已运行集群的可用性
- **SC-003**: 用户可以在30秒内通过kubectl创建中间件集群CR，平台在合理时间内完成集群部署（具体时间取决于中间件类型和规模）
- **SC-004**: PaaStatefulSet的精确缩容功能能够在指定Pod上正确执行pre-terminate钩子，钩子失败时保留Pod不删除
- **SC-005**: 有序重启功能能够按照扩展包定义的顺序执行，每个Pod重启后健康检查通过才继续下一个
- **SC-006**: 配置更新在CUE校验通过后，能够在10秒内通知到所有相关Pod
- **SC-007**: 备份任务执行成功率达到95%以上，失败的备份任务能够在状态中被识别并记录失败原因
- **SC-008**: 扩展包定义的告警规则能够正确触发，告警延迟不超过1分钟

### 架构目标
- **SC-009**: Operator自身支持Active-Active多活部署，具备leader选举能力
- **SC-010**: 平台不依赖外部结构化数据库或缓存，所有状态存储在Kubernetes CRD/etcd中
- **SC-011**: 监控数据通过标准Prometheus metrics接口暴露，不引入额外的metrics存储依赖

## 假设

### 技术假设
- **ASSUMPTION-1**: 目标Kubernetes集群版本支持Custom Resource Definition (CRD) 和Operator模式
- **ASSUMPTION-2**: 平台依赖的Kubernetes特性（如Pod原地更新）通过feature gate控制，在支持的版本中自动启用
- **ASSUMPTION-3**: 中间件Pod内的REST API由平台提供的基础镜像支持，扩展包构建的中间件镜像继承这些能力
- **ASSUMPTION-4**: 用户具备Kubernetes基础知识，能够通过kubectl操作CR资源
- **ASSUMPTION-5**: 外部监控系统（Prometheus）和证书管理（cert-manager）由用户自行部署和维护，平台只提供集成能力

### 业务假设
- **ASSUMPTION-6**: 平台主要面向平台团队和运维团队，不提供多租户隔离功能
- **ASSUMPTION-7**: 中间件集群的高可用性和数据一致性由中间件自身保证，平台负责协调操作不破坏已有高可用机制
- **ASSUMPTION-8**: 扩展包的开发和维护由熟悉特定中间件的团队负责，平台提供标准化的扩展机制
- **ASSUMPTION-9**: 备份数据的持久化存储（对象存储、NFS等）由用户自行提供，平台负责调用扩展包定义的备份步骤

### 限制说明
- **LIMITATION-1**: 平台专注于中间件的生命周期、备份、配置、监控告警管理，不提供SQL查询、数据迁移、性能调优等高级功能
- **LIMITATION-2**: 平台通过扩展包支持中间件，部分中间件特定的高级功能可能需要扩展包额外开发
- **LIMITATION-3**: TLS加密通信功能依赖cert-manager，如果用户未部署cert-manager，TLS功能不可用
- **LIMITATION-4**: 平台不提供内置的告警通知渠道（邮件、Slack等），依赖外部Alertmanager处理告警通知

## 风险与缓解措施

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 扩展包质量参差不齐 | 高 | 提供扩展包开发规范和最佳实践，建立扩展包审核机制 |
| Operator自身成为单点故障 | 高 | 支持Active-Active多活部署，确保Operator故障不影响已运行集群 |
| Pod REST API安全漏洞 | 中 | 限制API访问权限，支持TLS加密通信，定期安全审计 |
| CUE schema过于复杂 | 中 | 提供CUE schema模板和校验工具，降低扩展包开发门槛 |
| 大规模集群管理性能瓶颈 | 中 | 支持水平扩展，优化watch机制，提供性能调优指南 |

## 依赖关系

- **DEPENDENCY-1**: Kubernetes集群（版本1.24+）
- **DEPENDENCY-2**: Helm（用于平台部署）
- **DEPENDENCY-3**: cert-manager（可选，用于TLS证书管理）
- **DEPENDENCY-4**: Prometheus（可选，用于metrics采集）
- **DEPENDENCY-5**: Alertmanager（可选，用于告警通知）
