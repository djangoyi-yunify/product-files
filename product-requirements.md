# 特性规范：通用PaaS中间件管理平台

**创建时间**：2026-02-11

**特性概述**：
基于Kubernetes的通用、可扩展、轻量级PaaS中间件管理平台，支持管理多种中间件（Redis、PostgreSQL等），具备以下核心特性：
- 通过扩展机制支持任意中间件类型，添加新中间件无需修改平台代码或重启
- 提供专用工作负载，支持高级特性（指定缩容Pod编号、指定滚动重启顺序）
- 通过静态/动态分组抽象支持任意部署拓扑
- 通过统一REST API实现中间件生命周期管理
- 支持备份、配置管理、监控告警等核心功能
- 轻量级设计，不引入外部中间件依赖

## 用户场景和测试

### 用户故事1：快速创建中间件实例 (优先级 P1)
作为平台运维人员，我需要快速创建Redis或PostgreSQL中间件实例，无需深入了解Kubernetes细节。

**优先级原因**：这是平台最基础的功能，为用户提供即用型的中间件服务，大幅提升运维效率。

**独立测试**：可以通过创建Redis集群和PostgreSQL主从集群完成测试，验证平台能够成功部署并初始化中间件。

**验收场景**：
1. **给定** 平台已安装Redis扩展v1.0，**当** 用户提交创建3节点Redis集群的请求，**那么** 平台在5分钟内创建完成，集群状态变为Running，用户可以获取连接信息
2. **给定** 平台已安装PostgreSQL扩展v1.0，**当** 用户提交创建1主2从集群的请求，**那么** 平台自动完成主从复制配置，从节点同步主节点数据

### 用户故事2：动态扩缩容 (优先级 P1)
作为平台运维人员，我需要在不中断服务的情况下，对中间件集群进行扩缩容操作。

**优先级原因**：业务增长需要扩容，成本优化需要缩容，这是生产环境的核心需求。

**独立测试**：可以通过对现有Redis集群执行扩容和缩容操作完成测试，验证数据一致性和服务可用性。

**验收场景**：
1. **给定** 一个3节点的Redis集群正在运行，**当** 用户发起扩容到5节点的操作，**那么** 新节点自动加入集群，数据自动重平衡，整个过程服务可用
2. **给定** 一个5节点的Redis集群正在运行，**当** 用户指定删除节点编号2进行缩容，**那么** 节点2的数据迁移到其他节点后安全下线，集群缩容至4节点

### 用户故事3：扩展版本升级 (优先级 P1)
作为基础设施团队，我需要将Redis扩展从v1.0升级到v2.0，以支持更多功能，且不影响现有集群运行。

**优先级原因**：扩展升级是平台演进的必要能力，支持新功能而不影响现有服务。

**独立测试**：可以通过升级已安装的扩展版本，并验证现有集群继续正常运行完成测试。

**验收场景**：
1. **给定** 平台已安装Redis扩展v1.0，且有运行中的集群，**当** 安装Redis扩展v2.0并执行升级操作，**那么** 现有集群滚动重启完成升级，期间服务可用，扩展版本升级到v2.0
2. **给定** 升级过程中出现问题，**当** 用户执行回滚操作，**那么** 集群回滚到升级前状态，扩展版本回退到v1.0

### 用户故事4：添加新中间件支持 (优先级 P2)
作为基础设施团队，我需要添加Kafka支持，而无需修改平台核心代码或重启Operator。

**优先级原因**：平台的可扩展性是其核心价值，支持未来可能出现的任何中间件。

**独立测试**：可以通过开发并安装Kafka扩展，然后成功创建Kafka集群完成测试。

**验收场景**：
1. **给定** 平台运行正常，**当** 安装Kafka扩展v1.0，**那么** 平台自动识别扩展，用户可立即创建Kafka集群，无需重启Operator
2. **给定** Kafka扩展已安装，**当** 用户创建KRaft模式的Kafka集群，**那么** 平台正确部署controller和broker节点，集群正常运行

### 用户故事5：进程信号管理 (优先级 P2)
作为平台运维人员，我需要在不重启Pod的情况下，对中间件进程执行信号操作（如日志轮转信号）。

**优先级原因**：精细的进程控制能力满足高级运维需求，避免不必要的服务中断。

**独立测试**：可以通过对指定Pod的Redis进程发送信号完成测试，验证进程正确响应。

**验收场景**：
1. **给定** Redis集群正常运行，**当** 用户对指定Pod执行发送SIGUSR1信号操作（触发日志轮转），**那么** Redis进程接收信号并执行日志轮转，Pod不重启
2. **给定** 需要重新加载配置，**当** 用户执行进程优雅重启操作，**那么** Redis进程优雅重启加载新配置，连接保持不中断

### 边界情况
- 当扩展升级失败时，系统应支持自动或手动回滚到升级前状态
- 当缩容指定的Pod编号不存在时，系统应返回明确错误，不进行任何操作
- 当生命周期API调用超时或失败时，系统应根据扩展定义的策略决定重试或终止操作
- 当配置验证失败（Cue模板检查不通过）时，系统拒绝应用配置并返回详细错误信息
- 当备份存储不可用时，备份操作应失败并告警，不影响中间件正常运行

## 需求

### 功能需求

- **FR-001**: 系统必须支持通过统一CRD创建中间件实例，用户只需指定中间件类型、扩展版本、中间件版本和拓扑配置
- **FR-002**: 系统必须支持扩展机制，扩展以ConfigMap和Secret形式交付，包含Pod模板、生命周期API定义、Cue配置模板和元数据
- **FR-003**: 系统必须支持扩展的多版本共存，同一中间件类型可同时安装多个扩展版本
- **FR-004**: 系统必须支持扩展版本升级，升级过程中中间件版本保持不变，升级失败支持回滚
- **FR-005**: 系统必须提供专用工作负载 NodeSet，支持指定缩容时删除的Pod编号
- **FR-006**: NodeSet 必须支持指定滚动重启顺序，通过调用Pod REST API获取重启序列
- **FR-007**: 系统必须支持静态分组和动态分组的拓扑抽象，静态分组定义Pod模板，动态分组管理具体副本
- **FR-008**: 系统必须支持运行时管理静态分组和动态分组，包括添加、删除、修改
- **FR-009**: 系统必须定义通用生命周期REST API接口，扩展可选择性实现，包括pre-scale-in、post-scale-out、pre-upgrade、post-upgrade、health-check等
- **FR-010**: 系统必须通过Headless Service同步调用扩展提供的生命周期API
- **FR-011**: 系统必须支持通过REST API对单个Pod执行进程信号管理，包括配置热更新信号、日志轮转信号等
- **FR-012**: 系统必须支持自动备份，备份策略由用户配置，扩展定义备份步骤，备份存储于对象存储
- **FR-013**: 系统必须支持跨集群恢复，只要多集群能访问相同备份仓库
- **FR-014**: 系统必须支持配置热更新，通过Cue模板验证配置，扩展提供配置模板，用户提供完整配置文件
- **FR-015**: 系统必须支持配置回滚到上一版本
- **FR-016**: 系统必须通过Prometheus格式暴露监控指标，扩展在Pod模板中提供exporter sidecar定义
- **FR-017**: 系统必须支持多种日志收集方式，包括stdout输出、文件日志、日志轮转，由扩展通过sidecar实现
- **FR-018**: 系统必须集成cert-manager为中间件提供TLS证书和自动轮转能力
- **FR-019**: 系统必须支持私有镜像仓库，并支持配置镜像拉取密钥
- **FR-020**: 系统必须使用Kubernetes原生RBAC控制权限，用户的操作权限完全由其K8s权限决定
- **FR-021**: 中间件Pod必须自动探测并更新自身角色Label

### 关键数据实体

- **ENTITY-1**: Extension（扩展），代表一种中间件类型的支持包，包含扩展版本、支持的中间件版本列表、升级路径声明、元数据
- **ENTITY-2**: MiddlewareCluster（中间件集群），代表一个中间件实例，包含扩展版本、中间件版本、拓扑配置（静态分组和动态分组）、状态信息
- **ENTITY-3**: StaticGroup（静态分组），定义一组动态分组共享的Pod模板，包含资源配置、镜像信息、配置模板
- **ENTITY-4**: DynamicGroup（动态分组），代表一个NodeSet实例，包含副本数、特定配置覆盖、状态信息
- **ENTITY-5**: BackupPolicy（备份策略），定义自动备份的调度规则、保留策略，由用户配置
- **ENTITY-6**: BackupRecord（备份记录），代表一次备份的结果，包含备份类型、时间、存储位置、状态

## 成功标准

### 可衡量的结果

- **SC-001**: 用户可以在10分钟内完成新中间件集群的创建（从提交请求到集群可用）
- **SC-002**: 扩容操作在5分钟内完成，期间服务可用性不低于99.9%
- **SC-003**: 扩展升级过程支持零停机，滚动重启单个Pod的时间不超过30秒
- **SC-004**: 添加新中间件支持无需修改平台代码，新扩展安装后立即可用（无需重启Operator）
- **SC-005**: 平台可以管理数百个中间件集群，每个集群规模从单节点到数十个节点
- **SC-006**: 配置更新操作在1分钟内完成验证和应用（验证时间<10秒，滚动重启时间<60秒）
- **SC-007**: 备份成功率不低于99%，备份数据完整性可验证
- **SC-008**: 用户可以通过统一API管理所有类型的中间件，学习成本降低50%以上

## 假设

- 用户具备Kubernetes基础知识和操作权限
- 集群已安装cert-manager用于TLS证书管理
- 有可用的对象存储用于备份数据
- 扩展开发者熟悉Kubernetes CRD和Operator模式
- 所有中间件镜像都遵循容器化最佳实践，支持信号处理

## 约束

- 平台不引入外部中间件依赖（如结构化数据库、缓存等），仅依赖Kubernetes原生资源
- 暂不支持中间件暴露外部访问（Ingress/LoadBalancer）
- 暂不支持中间件密码自动生成和管理
- 告警规则由外部Prometheus Alertmanager自行配置，平台不处理告警通知
- 用户权限完全由Kubernetes RBAC控制，平台不实现额外的权限系统
